import React, { useContext, useMemo, useState } from "react";
import { Handle, Position } from "@xyflow/react";
import TaskNodeOptionModal from "./TaskNodeOptionModal";
import SelectUserModel from "./SelectUserModel";
import { cn } from "@/lib/utils";
import { FlowContext } from "../Flow";
import ConfirmDeleteModal from "@/components/General/ConfirmDeleteModal";
import { BusinessContext } from "@/Pages/layouts/BusinessLayout";

function UserNode({ data }) {
  const { value } = data;
  const { common } = useContext(BusinessContext);
  const { handleDeleteTask, handleIFrameChange } = useContext(FlowContext);
  const [showOptionsModal, setShowOptionsModal] = useState(false);
  const [showSelectUserModal, setShowSelectUserModal] = useState(false);
  const [showTaskDeleteModal, setTaskDeleteModal] = useState(false);
  
  const userType = useMemo(() => {
    if (value?.assign_to === "freelancer") {
      return "Freelancer";
    } else if (value?.assign_to === "self") {
      return "Me";
    } else if (value?.assign_to === "client") {
      return "Guest";
    } else if (value?.assign_to === "ai") {
      return "Ai";
    } else if (value?.assign_to === "team") {
      return "Team";
    } else {
      return "Unknown";
    }
  }, [value]);

  const iconType = useMemo(() => {
    if (value?.assign_to === "freelancer") {
      return (
        <svg width="20" height="19" viewBox="0 0 20 19" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M6.80859 4.33972C6.80859 6.16406 8.22515 8.34375 9.97251 8.34375C11.7199 8.34375 13.1364 6.16406 13.1364 4.33972C13.1364 2.004 11.7199 1.00111 9.97251 1.00111C8.22515 1.00111 6.80859 2.004 6.80859 4.33972Z"
            stroke="#2373DC"
            strokeWidth="1.2"
            strokeMiterlimit="10"
            strokeLinecap="round"
            strokeLinejoin="round"
          />
          <path
            d="M6.81055 4.42969C9.78229 4.42969 9.98821 3.44711 10.5677 3.32106C10.978 3.23184 11.3349 3.88534 13.1184 3.88534"
            stroke="#2373DC"
            strokeWidth="1.2"
            strokeMiterlimit="10"
            strokeLinecap="round"
            strokeLinejoin="round"
          />
          <path
            d="M5.875 11.7617C6.17523 9.83013 7.51843 8.37606 9.67537 8.37606H10.2699C12.4268 8.37606 13.77 9.83013 14.0703 11.7617"
            stroke="#2373DC"
            strokeWidth="1.2"
            strokeMiterlimit="10"
            strokeLinecap="round"
            strokeLinejoin="round"
          />
          <path d="M18.927 18H1.01758" stroke="#2373DC" strokeWidth="1.2" strokeMiterlimit="10" strokeLinecap="round" strokeLinejoin="round" />
          <path
            d="M4.02734 18H15.9174V12.2867C15.9174 11.9946 15.6679 11.7577 15.3601 11.7577H4.58469C4.27689 11.7577 4.02734 11.9946 4.02734 12.2867V18Z"
            stroke="#2373DC"
            strokeWidth="1.2"
            strokeMiterlimit="10"
            strokeLinecap="round"
            strokeLinejoin="round"
          />
        </svg>
      );
    } else if (value?.assign_to === "ai") {
      return (
        <svg width="16" height="18" viewBox="0 0 16 18" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M7.52067 8.52317C8.58406 8.52197 9.60355 8.09901 10.3555 7.34708C11.1074 6.59515 11.5304 5.57566 11.5316 4.51226V2.14633C11.531 1.57725 11.3047 1.03163 10.9023 0.629233C10.4999 0.226832 9.95432 0.000530983 9.38524 0H5.6561C5.08702 0.000530983 4.5414 0.226832 4.139 0.629233C3.7366 1.03163 3.5103 1.57725 3.50977 2.14633V4.51226C3.51096 5.57566 3.93392 6.59515 4.68585 7.34708C5.43778 8.09901 6.45728 8.52197 7.52067 8.52317ZM5.6561 1.00273H9.38524C9.68846 1.00299 9.97919 1.12356 10.1936 1.33797C10.408 1.55238 10.5286 1.84311 10.5288 2.14633V3.00818H7.52067C5.35929 3.00818 4.75114 2.21201 4.58018 1.77432C4.65695 1.54976 4.80186 1.35474 4.99472 1.21643C5.18758 1.07813 5.41878 1.00342 5.6561 1.00273ZM4.51249 3.24432C5.40852 3.81247 6.46201 4.08093 7.52067 4.0109H10.5288V4.51226C10.5288 5.31008 10.2119 6.07522 9.64777 6.63937C9.08363 7.20351 8.31849 7.52044 7.52067 7.52044C6.72285 7.52044 5.95771 7.20351 5.39357 6.63937C4.82942 6.07522 4.51249 5.31008 4.51249 4.51226V3.24432Z"
            fill="#249B32"
          />
          <path
            d="M13.1858 9.40414L11.226 8.56436C11.1653 8.53731 11.0999 8.5226 11.0334 8.52107C10.967 8.51954 10.901 8.53123 10.8391 8.55546C10.7772 8.57968 10.7208 8.61597 10.6731 8.66219C10.6254 8.70842 10.5873 8.76368 10.5611 8.82474C10.5349 8.88581 10.5212 8.95147 10.5206 9.01791C10.52 9.08434 10.5326 9.15023 10.5577 9.21175C10.5828 9.27326 10.6199 9.32918 10.6668 9.37623C10.7137 9.42329 10.7695 9.46056 10.8309 9.48587L12.7908 10.3256C13.1609 10.4839 13.4763 10.7473 13.6981 11.0832C13.9198 11.4192 14.0381 11.8128 14.0382 12.2153V16.0442H9.47826L9.03055 11.5685L9.51085 9.64781C9.52928 9.57391 9.53064 9.49679 9.51481 9.4223C9.49899 9.34781 9.4664 9.2779 9.41953 9.21788C9.37265 9.15786 9.31272 9.1093 9.24428 9.0759C9.17584 9.0425 9.10069 9.02513 9.02453 9.02511H6.01636C5.9402 9.02513 5.86505 9.0425 5.79661 9.0759C5.72817 9.1093 5.66823 9.15786 5.62136 9.21788C5.57448 9.2779 5.5419 9.34781 5.52607 9.4223C5.51025 9.49679 5.5116 9.57391 5.53003 9.64781L6.01034 11.5685L5.56513 16.0442H1.00273V12.2153C1.00268 11.8129 1.1207 11.4194 1.34217 11.0835C1.56364 10.7476 1.87881 10.4841 2.24861 10.3256L4.20844 9.48587C4.26987 9.46056 4.32566 9.42329 4.37257 9.37623C4.41947 9.32918 4.45655 9.27326 4.48166 9.21175C4.50677 9.15023 4.51939 9.08434 4.51881 9.01791C4.51823 8.95147 4.50445 8.88581 4.47827 8.82474C4.45209 8.76368 4.41403 8.70842 4.36631 8.66219C4.31859 8.61597 4.26215 8.57968 4.20029 8.55546C4.13842 8.53123 4.07236 8.51954 4.00593 8.52107C3.93951 8.5226 3.87405 8.53731 3.81337 8.56436L1.85504 9.40414C1.30431 9.63927 0.834843 10.0311 0.505023 10.5309C0.175203 11.0307 -0.000417023 11.6165 7.43605e-07 12.2153V16.5456C7.43605e-07 16.6785 0.0528227 16.806 0.146846 16.9001C0.24087 16.9941 0.368394 17.0469 0.501364 17.0469H14.5395C14.6725 17.0469 14.8 16.9941 14.894 16.9001C14.9881 16.806 15.0409 16.6785 15.0409 16.5456V12.2153C15.0413 11.6165 14.8657 11.0307 14.5359 10.5309C14.206 10.0311 13.7366 9.63927 13.1858 9.40414ZM8.38229 10.0278L8.1316 11.0306H6.90928L6.6586 10.0278H8.38229ZM6.57036 16.0442L6.97145 12.0333H8.07194L8.47303 16.0442H6.57036Z"
            fill="#249B32"
          />
        </svg>
      );
    } else if (value?.assign_to === "team") {
      return (
        <svg width="20" height="17" viewBox="0 0 20 17" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M12.8061 8.5004C13.9631 7.64003 14.7175 6.26692 14.7175 4.7173C14.7175 2.11604 12.6014 0 10.0002 0C7.3989 0 5.28286 2.11604 5.28286 4.7173C5.28286 6.26692 6.03719 7.64003 7.1942 8.5004C5.13185 9.19367 3.64062 11.1413 3.64062 13.4338V14.0915C3.64062 14.8713 4.1943 15.5438 4.95736 15.6901C6.6157 16.0075 8.31229 16.1679 10.0008 16.1679C11.6894 16.1679 13.386 16.0069 15.045 15.6901C15.8074 15.5438 16.361 14.8713 16.361 14.0915V13.4338C16.3597 11.1413 14.8678 9.19367 12.8061 8.5004ZM6.4902 4.7173C6.4902 2.78246 8.06465 1.20802 9.99949 1.20802C11.9343 1.20802 13.5088 2.78246 13.5088 4.7173C13.5088 6.65214 11.9343 8.22659 9.99949 8.22659C8.06465 8.22659 6.4902 6.65281 6.4902 4.7173ZM15.151 14.0915C15.151 14.2928 15.0101 14.4667 14.8161 14.5036C11.6491 15.1089 8.3492 15.1089 5.18353 14.5036C4.9889 14.466 4.84797 14.2928 4.84797 14.0915V13.4338C4.84797 11.2285 6.64187 9.4346 8.8465 9.4346H11.1525C13.3571 9.4346 15.151 11.2285 15.151 13.4338V14.0915Z"
            fill="#92883E"
          />
          <path
            d="M17.4214 8.2817C18.2146 7.56092 18.6972 6.5227 18.6972 5.41736C18.6972 3.82278 17.7381 2.4141 16.2543 1.82889C15.9456 1.70741 15.5939 1.85842 15.4711 2.16914C15.3483 2.4792 15.5006 2.8302 15.8113 2.95234C16.8308 3.35434 17.4885 4.3221 17.4885 5.41669C17.4885 6.50726 16.8053 7.50186 15.7892 7.89312C15.5315 7.99245 15.3738 8.25351 15.4067 8.528C15.4389 8.80249 15.6536 9.01926 15.9268 9.0555C17.4254 9.25348 18.7911 10.8078 18.7911 12.3158V12.8326C18.7911 12.9312 18.7213 13.0205 18.626 13.0393C18.5072 13.0628 18.3837 13.0842 18.2562 13.1064L17.9985 13.1513C17.6703 13.2111 17.4529 13.5252 17.512 13.8533C17.565 14.1453 17.8193 14.3493 18.1059 14.3493C18.1421 14.3493 18.1777 14.3459 18.2146 14.3392L18.4603 14.2963C18.5985 14.2721 18.7334 14.2493 18.8609 14.2238C19.52 14.0943 19.9991 13.5091 19.9991 12.8326V12.3158C19.9991 10.6508 18.9079 9.04208 17.4214 8.2817Z"
            fill="#92883E"
          />
          <path
            d="M2.00061 13.1523L1.7429 13.1073C1.61606 13.0852 1.4919 13.0644 1.3711 13.0395C1.27848 13.0214 1.20802 12.9328 1.20802 12.8335V12.3168C1.20802 10.8087 2.57307 9.25443 4.07235 9.05645C4.3455 9.02021 4.56093 8.80344 4.59247 8.52895C4.62536 8.25446 4.46697 7.9934 4.20993 7.89407C3.19319 7.50281 2.51066 6.50754 2.51066 5.41764C2.51066 4.32237 3.16836 3.35462 4.18779 2.95329C4.49852 2.83047 4.65019 2.47948 4.52804 2.16942C4.40523 1.85869 4.05289 1.70702 3.74485 1.82916C2.261 2.41438 1.30197 3.82306 1.30197 5.41764C1.30197 6.5223 1.78518 7.5612 2.57777 8.28198C1.09124 9.04169 0 10.6504 0 12.3168V12.8335C0 13.51 0.479179 14.0952 1.13621 14.2241C1.26506 14.2502 1.40063 14.2731 1.53888 14.2972L1.78451 14.3402C1.82142 14.3469 1.85699 14.3502 1.89323 14.3502C2.1798 14.3502 2.43415 14.1456 2.48717 13.8543C2.5469 13.5261 2.32879 13.212 2.00061 13.1523Z"
            fill="#92883E"
          />
        </svg>
      );
    } else {
      return (
        <svg width="16" height="18" viewBox="0 0 16 18" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M7.52067 8.52317C8.58406 8.52197 9.60355 8.09901 10.3555 7.34708C11.1074 6.59515 11.5304 5.57566 11.5316 4.51226V2.14633C11.531 1.57725 11.3047 1.03163 10.9023 0.629233C10.4999 0.226832 9.95432 0.000530983 9.38524 0H5.6561C5.08702 0.000530983 4.5414 0.226832 4.139 0.629233C3.7366 1.03163 3.5103 1.57725 3.50977 2.14633V4.51226C3.51096 5.57566 3.93392 6.59515 4.68585 7.34708C5.43778 8.09901 6.45728 8.52197 7.52067 8.52317ZM5.6561 1.00273H9.38524C9.68846 1.00299 9.97919 1.12356 10.1936 1.33797C10.408 1.55238 10.5286 1.84311 10.5288 2.14633V3.00818H7.52067C5.35929 3.00818 4.75114 2.21201 4.58018 1.77432C4.65695 1.54976 4.80186 1.35474 4.99472 1.21643C5.18758 1.07813 5.41878 1.00342 5.6561 1.00273ZM4.51249 3.24432C5.40852 3.81247 6.46201 4.08093 7.52067 4.0109H10.5288V4.51226C10.5288 5.31008 10.2119 6.07522 9.64777 6.63937C9.08363 7.20351 8.31849 7.52044 7.52067 7.52044C6.72285 7.52044 5.95771 7.20351 5.39357 6.63937C4.82942 6.07522 4.51249 5.31008 4.51249 4.51226V3.24432Z"
            fill="#249B32"
          />
          <path
            d="M13.1858 9.40414L11.226 8.56436C11.1653 8.53731 11.0999 8.5226 11.0334 8.52107C10.967 8.51954 10.901 8.53123 10.8391 8.55546C10.7772 8.57968 10.7208 8.61597 10.6731 8.66219C10.6254 8.70842 10.5873 8.76368 10.5611 8.82474C10.5349 8.88581 10.5212 8.95147 10.5206 9.01791C10.52 9.08434 10.5326 9.15023 10.5577 9.21175C10.5828 9.27326 10.6199 9.32918 10.6668 9.37623C10.7137 9.42329 10.7695 9.46056 10.8309 9.48587L12.7908 10.3256C13.1609 10.4839 13.4763 10.7473 13.6981 11.0832C13.9198 11.4192 14.0381 11.8128 14.0382 12.2153V16.0442H9.47826L9.03055 11.5685L9.51085 9.64781C9.52928 9.57391 9.53064 9.49679 9.51481 9.4223C9.49899 9.34781 9.4664 9.2779 9.41953 9.21788C9.37265 9.15786 9.31272 9.1093 9.24428 9.0759C9.17584 9.0425 9.10069 9.02513 9.02453 9.02511H6.01636C5.9402 9.02513 5.86505 9.0425 5.79661 9.0759C5.72817 9.1093 5.66823 9.15786 5.62136 9.21788C5.57448 9.2779 5.5419 9.34781 5.52607 9.4223C5.51025 9.49679 5.5116 9.57391 5.53003 9.64781L6.01034 11.5685L5.56513 16.0442H1.00273V12.2153C1.00268 11.8129 1.1207 11.4194 1.34217 11.0835C1.56364 10.7476 1.87881 10.4841 2.24861 10.3256L4.20844 9.48587C4.26987 9.46056 4.32566 9.42329 4.37257 9.37623C4.41947 9.32918 4.45655 9.27326 4.48166 9.21175C4.50677 9.15023 4.51939 9.08434 4.51881 9.01791C4.51823 8.95147 4.50445 8.88581 4.47827 8.82474C4.45209 8.76368 4.41403 8.70842 4.36631 8.66219C4.31859 8.61597 4.26215 8.57968 4.20029 8.55546C4.13842 8.53123 4.07236 8.51954 4.00593 8.52107C3.93951 8.5226 3.87405 8.53731 3.81337 8.56436L1.85504 9.40414C1.30431 9.63927 0.834843 10.0311 0.505023 10.5309C0.175203 11.0307 -0.000417023 11.6165 7.43605e-07 12.2153V16.5456C7.43605e-07 16.6785 0.0528227 16.806 0.146846 16.9001C0.24087 16.9941 0.368394 17.0469 0.501364 17.0469H14.5395C14.6725 17.0469 14.8 16.9941 14.894 16.9001C14.9881 16.806 15.0409 16.6785 15.0409 16.5456V12.2153C15.0413 11.6165 14.8657 11.0307 14.5359 10.5309C14.206 10.0311 13.7366 9.63927 13.1858 9.40414ZM8.38229 10.0278L8.1316 11.0306H6.90928L6.6586 10.0278H8.38229ZM6.57036 16.0442L6.97145 12.0333H8.07194L8.47303 16.0442H6.57036Z"
            fill="#249B32"
          />
        </svg>
      );
    }
  }, [value]);

  const getRedirctUrl = useMemo(() => {
    if (value?.assign_to === "freelancer") {
      return "my-freelancer-index";
    } else if (value?.assign_to === "ai") {
      return "aiagent";
    } else if (value?.assign_to === "team") {
      return "teams";
    } else if (value?.assign_to === "client") {
      return "guests";
    } else {
      return "private-profile";
    }
  }, [value]);

  const users = useMemo(() => {
    if (value?.assign_to === "freelancer") {
      return common?.freelancers;
    } else if (value?.assign_to === "team") {
      return common?.teams;
    } else if (value?.assign_to === "client") {
      return common?.clients;
    } else {
      return [];
    }
  }, [common]);

  const assingnUserName = useMemo(() => {
      if (value.assign_to == "team" || value.assign_to == "freelancer" || value.assign_to == "assign_to" || value.assign_to == "client" || value.assign_to == "self") {
        const user = value.user_member;
        return user ? `${user.first_name} ${user.last_name}` : "";
      } else if (value.assign_to == "ai") {
        const user = value.ai_member;
        return user ? `${user?.name}` : "";
      } else {
        return "";
      }
    }, [value]);

  return (
    <div className={cn("flex flex-col items-center justify-between border border-[#6DC3C8] rounded-lg shadow-sm bg-white w-96 p-2")}>
      <Handle type="target" position={Position.Top} className="w-2" />
      <div className="flex items-start justify-between gap-2 w-full pb-2">
        <div className="flex items-center gap-2 w-full">
          <div className="max-w-[43px] w-full px-2">
            <img
              src={value?.member?.avatar || "/images/user.jpg"}
              alt="profile"
              className="w-full h-auto"
              onError={(e) => {
                const target = e.target;
                if (target instanceof HTMLImageElement) {
                  target.src = "/images/user.jpg";
                  target.onerror = null;
                }
              }}
            />
          </div>
          <div>
            <button type="button" className="flex items-center gap-2 mb-1">
              {iconType}
              <h3 className="text-sm text-[#F1578F] font-medium capitalize">
                {assingnUserName}
              </h3>
            </button>
            <div>
              <p className="text-[#625D66] font-normal text-sm">User Type: {userType} </p>
              <button onClick={() => handleIFrameChange(`${getRedirctUrl}?reactframe=true`)} className="text-sm font-medium text-[#59A8B2] block cursor-pointer underline mt-1">
                User Details
              </button>
            </div>
          </div>
        </div>
        <div
          className="max-w-[20px] w-full flex justify-center items-center size-5 cursor-pointer"
          onClick={() => setShowOptionsModal((prevOpen) => !prevOpen)}
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="size-6">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z"
            />
          </svg>
        </div>
      </div>
      <ConfirmDeleteModal isOpen={showTaskDeleteModal} setIsOpen={setTaskDeleteModal} onConfirm={() => handleDeleteTask(value.uuid)} />
      <TaskNodeOptionModal
        isOpen={showOptionsModal}
        setIsOpen={setShowOptionsModal}
        setShowEditModal={setShowSelectUserModal}
        tsdetails={value}
        setTaskDeleteModal={setTaskDeleteModal}
      />
      <SelectUserModel open={showSelectUserModal} setOpen={setShowSelectUserModal} tsdetails={value} users={users} />
    </div>
  );
}

export default UserNode;
